<script>
// පිටුව සම්පූර්ණයෙන්ම load වෙනකල් ඉන්නවා.
document.addEventListener('DOMContentLoaded', () => {
    const fileName = "{{file_name}}";
    const fileUrl = "{{file_url}}";
    const videoElement = document.getElementById('player');

    // === START: "ද්විත්ව විධානය" සඳහා අවශ්‍ය දේවල් ===
    const noticeBox = document.getElementById('floating-notice');
    const timerElement = document.getElementById('countdown-timer');
    const closeBtn = document.getElementById('notice-close-btn');
    
    const attachNoticeLogic = (player) => {
        let countdownInterval = null;
        let timeLeft = 60;
        
        // මේවා තමයි අපේ control variables
        let isPlaybackLocked = false; // Timer එක වැඩ කරනකොට play කරන්න බෑ
        let hasMagicBeenTriggered = false; // මායාව එක පාරයි වෙන්නේ
        let lastPlayAttemptTime = 0; // Double-tap එක අල්ලගන්න
        const DOUBLE_TAP_THRESHOLD = 500; // මිලි තත්පර 500ක් ඇතුලත

        const endTheWait = () => {
            clearInterval(countdownInterval);
            isPlaybackLocked = false;
            noticeBox.classList.remove('visible');
            noticeBox.classList.add('hidden');
        };

        closeBtn.addEventListener('click', endTheWait);

        // ==========================================================
        // === මෙන්න අපේ ද්විත්ව විධාන මොළය! ===
        // ==========================================================
        player.on('play', () => {
            // 1. Timer එක වැඩ කරන වෙලාවෙ user play කරන්න හැදුවොත්...
            if (isPlaybackLocked) {
                player.pause(); // බලෙන් නවත්වනවා
                return;
            }

            // 2. මායාව දැනටමත් වෙලා ඉවරනම්...
            if (hasMagicBeenTriggered || !fileName.toLowerCase().endsWith('.mkv')) {
                return; // මුකුත් කරන්න එපා, සාමාන්‍ය විදියට play වෙන්න දෙන්න
            }

            // 3. Double-tap එක අල්ලගන්න තැන
            const currentTime = new Date().getTime();
            const timeSinceLastTap = currentTime - lastPlayAttemptTime;

            if (timeSinceLastTap < DOUBLE_TAP_THRESHOLD) {
                // --- Double-tap එක අහු වුනා! ---
                
                // මායාව පටන් ගන්නවා
                hasMagicBeenTriggered = true;
                isPlaybackLocked = true;
                
                player.pause(); // වීඩියෝ එක pause කරනවා

                // Notice එක පෙන්නලා timer එක පටන් ගන්නවා
                noticeBox.classList.remove('hidden');
                noticeBox.classList.add('visible');

                timerElement.textContent = timeLeft;
                countdownInterval = setInterval(() => {
                    timeLeft--;
                    timerElement.textContent = timeLeft;
                    if (timeLeft <= 0) {
                        endTheWait();
                    }
                }, 1000);

            } else {
                // මේ පළවෙනි tap එක විතරයි. ඒ නිසා වෙලාව සටහන් කරගන්නවා.
                lastPlayAttemptTime = currentTime;
            }
        });
    };
    // === END: "ද්විත්ව විධානය" සඳහා අවශ්‍ය දේවල් ===

    const attachExtraFeatures = (player) => {
        // ඔයාගේ මේ function එකේ එක අකුරක්වත් වෙනස් කරලා නෑ
        player.on('enterfullscreen', () => { if (window.screen.width < 768) { try { if (screen.orientation && typeof screen.orientation.lock === 'function') { screen.orientation.lock('landscape').catch(() => {}); } } catch (err) {} } });
        player.on('exitfullscreen', () => { if (window.screen.width < 768) { try { if (screen.orientation && typeof screen.orientation.unlock === 'function') { screen.orientation.unlock(); } } catch (err) {} } });
        const playerContainer = player.elements.container;
        const rewindIndicator = document.createElement('div');
        rewindIndicator.className = 'skip-indicator skip-indicator-rewind';
        rewindIndicator.innerHTML = `<span class="arrows">&laquo;</span><span>10s</span>`;
        playerContainer.appendChild(rewindIndicator);
        const forwardIndicator = document.createElement('div');
        forwardIndicator.className = 'skip-indicator skip-indicator-forward';
        forwardIndicator.innerHTML = `<span class="arrows">&raquo;</span><span>10s</span>`;
        playerContainer.appendChild(forwardIndicator);
        let tapTimeout = null;
        let lastTapTime = 0;
        const DOUBLE_TAP_DELAY = 300;
        playerContainer.addEventListener('touchend', (e) => {
            if (e.target.closest('.plyr__controls')) return;
            if (!e.changedTouches || e.changedTouches.length === 0) return;
            const currentTime = new Date().getTime();
            const tapLength = currentTime - lastTapTime;
            clearTimeout(tapTimeout);
            if (tapLength < DOUBLE_TAP_DELAY && tapLength > 0) {
                e.preventDefault(); e.stopPropagation();
                const rect = playerContainer.getBoundingClientRect();
                const touchX = e.changedTouches[0].clientX;
                const tapPositionX = touchX - rect.left;
                if (tapPositionX < rect.width * 0.35) { player.rewind(10); rewindIndicator.classList.add('visible'); setTimeout(() => rewindIndicator.classList.remove('visible'), 500); }
                else if (tapPositionX > rect.width * 0.65) { player.forward(10); forwardIndicator.classList.add('visible'); setTimeout(() => forwardIndicator.classList.remove('visible'), 500); }
                else { player.fullscreen.toggle(); }
                lastTapTime = 0;
            } else {
                tapTimeout = setTimeout(() => { player.togglePlay(); }, DOUBLE_TAP_DELAY);
            }
            lastTapTime = currentTime;
        });
        const styles = `.skip-indicator { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0, 0, 0, 0.4); color: white; padding: 15px 25px; border-radius: 50px; font-family: 'Josefin Sans', sans-serif; font-size: 1.2em; opacity: 0; transition: opacity 0.3s ease-out; pointer-events: none; display: flex; flex-direction: column; align-items: center; backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); } .skip-indicator.visible { opacity: 1; } .skip-indicator .arrows { font-size: 2.5em; line-height: 1; font-weight: bold; } .skip-indicator-rewind { left: 10%; } .skip-indicator-forward { right: 10%; }`;
        const styleSheet = document.createElement("style");
        styleSheet.innerText = styles;
        document.head.appendChild(styleSheet);
        document.getElementById('heading').style.visibility = 'visible';
    };

    // --- ඔයාගේ මුල්, වැඩ කරන කෝඩ් එක ---
    if (fileName.toLowerCase().endsWith('.mkv')) {
        fetch(`/subtitles/${fileUrl.split('/').pop()}`)
            .then(response => response.json())
            .then(subtitles => {
                let tracks = [];
                if (subtitles && subtitles.length > 0) {
                    tracks = subtitles.map((sub, i) => ({
                        kind: 'subtitles',
                        label: sub.label || sub.language.toUpperCase(),
                        srclang: sub.language.substring(0, 2),
                        src: `/subtitle/${fileUrl.split('/').pop()}?index=${sub.index}`,
                        default: i === 0
                    }));
                }
                const player = new Plyr(videoElement, { captions: { active: true, update: true, language: 'auto' } });
                player.source = {
                    type: 'video',
                    title: fileName,
                    sources: [{ src: fileUrl, type: 'video/mp4' }],
                    tracks: tracks
                };
                attachExtraFeatures(player);
                attachNoticeLogic(player);
            })
            .catch(err => {
                const player = new Plyr(videoElement);
                player.source = { type: 'video', title: fileName, sources: [{ src: fileUrl, type: 'video/mp4' }] };
                attachExtraFeatures(player);
                attachNoticeLogic(player);
            });
    } else {
        const player = new Plyr(videoElement);
        player.source = { type: 'video', title: fileName, sources: [{ src: fileUrl, type: 'video/mp4' }] };
        attachExtraFeatures(player);
    }
});
</script>
