<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POP Tv One | {{file_name}}</title>
    <link rel="icon" href="https://raw.githubusercontent.com/dilusha034/FileStreamBot/main/photo_2025-09-24_00-54-09.jpg?v=2" type="image/x-icon">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/proavipatil/data@main/fs/src/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/proavipatil/data@main/fs/src/plyr.css">
    <link href="https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@500;700&display=swap" rel="stylesheet">
    
    <!-- === START: අපේ අලුත් Animation එක සඳහා CSS === -->
    <style>
        #loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            flex-direction: column;
            font-family: 'Josefin Sans', sans-serif;
            color: white;
            transition: opacity 0.5s ease-in-out;
            opacity: 1;
        }

        #loading-overlay.hidden {
            opacity: 0;
            pointer-events: none; /* Hide උනාට පස්සේ click කරන්න බැරි වෙන්න */
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        #loading-overlay p {
            font-size: 1.2em;
            text-align: center;
            padding: 0 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <!-- === END: CSS === -->
</head>
<body>
    <!-- Navigation and other elements... (no changes here) -->
   <div class="outer">
        <div class="inner">
            <div class="main" id="main" style="position: relative;"> <!-- position relative එකතු කළා -->
                <!-- === START: අපේ අලුත් Loading Message එක === -->
                <div id="loading-overlay">
                    <div class="spinner"></div>
                    <p>උපසිරැසි සූදානම් කරමින් පවතී...<br>කරුණාකර වීඩියෝව skip නොකර මොහොතක් රැඳී සිටින්න.</p>
                </div>
                <!-- === END: Loading Message === -->
                
                <video id="player" playsinline controls width="100%"></video>
                
                <!-- File name, size, and download buttons... (no changes here) -->
                <div class="file-name">
                    <h4 style="display: inline;">ගොනුවේ නම: </h4>
                    <p style="display: inline;">{{file_name}}</p><br>
                    <h4 style="display: inline;">ගොනුවේ ප්‍රමාණය: </h4>
                    <p style="display: inline;">{{file_size}}</p>
                </div>
                <div class="downloadBtn">
                    <button class="magnet" onclick="streamDownload()">බාගත කරන්න</button>
                    <button class="magnet" onclick="copyStreamLink()">ලින්ක් එක කොපි කරන්න</button>
                    <button class="magnet" onclick="vlc_player()">VLC Player</button>
                    <button class="magnet" onclick="mx_player()">MX Player</button>
                    <button class="magnet" onclick="n_player()">nPlayer</button>
                </div>
            </div>
            <!-- About section and footer... (no changes here) -->
        </div>
    </div>
</body>
<script src="https://cdn.plyr.io/3.6.9/plyr.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const fileName = "{{file_name}}";
    const fileUrl = "{{file_url}}";
    const videoElement = document.getElementById('player');
    const loadingOverlay = document.getElementById('loading-overlay');

    const attachExtraFeatures = (player) => {
        // Touch controls, auto-rotation etc. (no changes needed here)
    };

    const initializePlayer = (tracks = []) => {
        const player = new Plyr(videoElement, { captions: { active: true, update: true } });
        
        // --- මෙන්න වැදගත්ම කොටස ---
        // Player එක සම්පූර්ණයෙන්ම සූදානම් වුනාම, loading screen එක අයින් කරනවා
        player.on('ready', () => {
            console.log("Player is ready! Hiding loading screen.");
            loadingOverlay.classList.add('hidden');
        });

        player.source = {
            type: 'video',
            title: fileName,
            sources: [{ src: fileUrl, type: 'video/mp4' }],
            tracks: tracks
        };
        attachExtraFeatures(player);
    };

    if (fileName.toLowerCase().endsWith('.mkv')) {
        fetch(`/subtitles/${fileUrl.split('/').pop()}`)
            .then(response => response.json())
            .then(subtitles => {
                let tracks = [];
                if (subtitles && subtitles.length > 0) {
                    tracks = subtitles.map((sub, i) => ({
                        kind: 'subtitles',
                        label: sub.label || sub.language.toUpperCase(),
                        srclang: sub.language.substring(0, 2),
                        src: `/subtitle/${fileUrl.split('/').pop()}?index=${sub.index}`,
                        default: i === 0
                    }));
                }
                initializePlayer(tracks);
            })
            .catch(err => {
                console.error("Subtitle fetch failed, starting player without subs.", err);
                initializePlayer();
            });
    } else {
        initializePlayer();
    }
});
</script>
</html>
